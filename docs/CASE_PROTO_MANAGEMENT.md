# Protobuf 管理案例（集中 + 分布同步）

本案例展示如何在多微服务场景下既支持集中管理又支持分布式开发，通过分支隔离和 CI 同步逐步收敛。

## 场景概述
- 团队有公共协议与多个微服务私有协议。
- 协议管理仓（Protocol Repo）作为唯一源；SDK 仓（可选）仅存生成物。
- 各服务可在自身仓库开发 proto，再同步到协议仓的隔离分支，经 PR 合并。

## 目录规范（协议管理仓）
- 公共协议：`proto/common/**`
- 服务协议：`proto/services/<service>/**`
- 可选内部：`proto/internal/**`
- 统一包名：`package` / `go_package` 以 `<org>.<domain>` 或 `<org>.<service>` 为前缀。

## 分支与权限
- 同步分支：`sync/<service>`（服务团队可写）。
- 主分支：仅通过 PR 合并。
- CODEOWNERS 按目录分权；公共目录需严格审核。
- SDK 仓：与协议仓使用相同分支/标签，禁止手改生成物。

## CI 流程
1) **服务仓 → 协议仓**：
   - 同步本服务目录到协议仓 `sync/<service>` 分支；自动创建 PR。
2) **协议仓合并/打 tag**：
   - 运行 lint/兼容性检查（禁止字段删除、tag 复用）。
   - 生成多语言 SDK，推送到 SDK 仓，同名分支 + 同名 tag。
3) **SDK 仓发布**（可选）：
   - 按语言子目录（go/js/python），发布到对应包管理器。

## 版本与兼容性
- 公共/跨服务接口遵循 SemVer：新增字段、不复用 tag；不兼容改动用新包/新 service 名（如 v2）。
- 消费端固定依赖协议仓 tag/commit，避免漂移。

## 实操示例
- 协议仓脚本与 CI 示例见 `docs/EXAMPLES.md` 中“示例 8: 协议仓 + SDK 仓自动发布”。
- 生成脚本要点：
  - 生成后 `rsync --delete` 同步到 SDK 仓子目录。
  - 使用与协议仓当前分支一致的 `SDK_BRANCH` 推送，避免覆盖他人分支。
  - 协议仓 tag 与 SDK 仓 tag 一一对应。

## 渐进落地步骤
1. 在协议仓创建目录规范和 CODEOWNERS，提供生成配置模板。
2. 为服务仓提供同步脚本/CI：同步到 `sync/<service>` + 自动 PR。
3. 协议仓启用 lint/兼容性检查 + 生成/发布流水线（打 tag 自动触发）。
4. 阶段性收敛，逐步让服务依赖协议仓 tag，减少分散版本。
